# Parallel Agent System with Queue-Based Concurrency

> Created: 2026-01-15
> Status: âœ… Complete

## Overview

`opencode-orchestrator` now provides a **parallel agent execution system** with queue-based concurrency control. This allows the AI to spawn multiple agents in parallel sessions while maintaining safety and preventing resource exhaustion.

### Key Benefits
- Run multiple agents concurrently for faster task completion
- Queue-based concurrency prevents overloading (max 3 per agent type)
- Batched notifications reduce context switching
- Automatic cleanup prevents memory leaks

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OpenCode Orchestrator                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚   Parallel Agents (Session-based)                                â”‚
â”‚   â”œâ”€â”€ ParallelAgentManager (src/core/async-agent.ts)            â”‚
â”‚   â”‚   â”œâ”€â”€ ConcurrencyController (queue-based rate limiting)     â”‚
â”‚   â”‚   â”œâ”€â”€ Task tracking per parent session                       â”‚
â”‚   â”‚   â”œâ”€â”€ Batched notification system                           â”‚
â”‚   â”‚   â””â”€â”€ Delayed cleanup (5 min after completion)              â”‚
â”‚   â”‚                                                               â”‚
â”‚   â”œâ”€â”€ Tools (src/tools/async-agent.ts)                           â”‚
â”‚   â”‚   â”œâ”€â”€ delegate_task  - Delegate task (background=true/false)â”‚
â”‚   â”‚   â”œâ”€â”€ get_task_result - Retrieve completed task result      â”‚
â”‚   â”‚   â”œâ”€â”€ list_tasks      - View all parallel tasks             â”‚
â”‚   â”‚   â””â”€â”€ cancel_task     - Stop running task                   â”‚
â”‚   â”‚                                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚   Background Tasks (Shell commands)                               â”‚
â”‚   â”œâ”€â”€ BackgroundTaskManager (src/core/background.ts)             â”‚
â”‚   â”‚   â””â”€â”€ child_process.spawn() for command execution            â”‚
â”‚   â”‚                                                               â”‚
â”‚   â”œâ”€â”€ Tools (src/tools/background.ts)                            â”‚
â”‚   â”‚   â”œâ”€â”€ run_background   - Start command in background         â”‚
â”‚   â”‚   â”œâ”€â”€ check_background - Check status and output             â”‚
â”‚   â”‚   â”œâ”€â”€ list_background  - List all background tasks           â”‚
â”‚   â”‚   â””â”€â”€ kill_background  - Terminate running task              â”‚
â”‚   â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Safety Features

### 1. Queue-Based Concurrency

Each agent type has a separate concurrency limit (default: 3). When the limit is reached, additional requests are queued and processed as slots become available.

```typescript
// ConcurrencyController
async acquire(key: string): Promise<void> {
    const limit = this.getLimit(key);  // default: 3
    const current = this.counts.get(key) ?? 0;
    
    if (current < limit) {
        this.counts.set(key, current + 1);
        return;  // Slot acquired
    }
    
    // Queue and wait for a slot
    return new Promise<void>((resolve) => {
        const queue = this.queues.get(key) ?? [];
        queue.push(resolve);
        this.queues.set(key, queue);
    });
}
```

### 2. Batched Notifications

Instead of notifying on each task completion, the system waits until ALL tasks for a parent session complete, then sends a single summary notification.

```typescript
// Only notify when ALL tasks complete
if (pending && pending.size > 0) {
    return;  // Wait for remaining tasks
}

// All complete - send summary
await this.client.session.prompt({
    path: { id: parentSessionID },
    body: {
        noReply: true,
        parts: [{ type: "text", text: notification }],
    },
});
```

### 3. Automatic Cleanup

Completed tasks are removed from memory after 5 minutes to prevent memory leaks.

```typescript
private scheduleCleanup(taskId: string): void {
    setTimeout(() => {
        this.tasks.delete(taskId);
    }, 5 * 60 * 1000);  // 5 minutes
}
```

### 4. TTL Enforcement

Tasks that exceed 30 minutes are automatically marked as timed out.

```typescript
if (age > TASK_TTL_MS) {
    task.status = "timeout";
    task.error = "Task exceeded 30 minute time limit";
    this.concurrency.release(task.concurrencyKey);
    this.tasks.delete(taskId);
}
```

### 5. Output Validation

Before marking a task as complete, the system verifies the session has actual content (not just an empty response).

```typescript
private async validateSessionHasOutput(sessionID: string): Promise<boolean> {
    const messages = await this.client.session.messages({ path: { id: sessionID } });
    return messages.some(m => 
        m.info?.role === "assistant" && 
        m.parts?.some(p => p.type === "text" && p.text?.trim())
    );
}
```

### 6. Process-Safe Polling

The polling interval uses `unref()` to allow Node.js to exit even if polling is active.

```typescript
this.pollingInterval = setInterval(() => {
    this.pollRunningTasks();
}, POLL_INTERVAL_MS);
this.pollingInterval.unref();  // Allow process to exit
```

---

## Available Tools

### Parallel Agent Tools

#### `spawn_agent`

Launch an agent in a parallel session.

**Input:**
```typescript
{
  agent: "builder",           // Agent name
  description: "Implement X", // Short description
  prompt: "Full instructions" // Detailed prompt
}
```

**Output:**
```
ğŸš€ **Agent Spawned**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
| Property | Value |
|----------|-------|
| **Task ID** | `task_a1b2c3d4` |
| **Agent** | builder |
| **Status** | â³ running |
| **Total Running** | 2 |
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

#### `get_task_result`

Retrieve the result from a completed task.

**Input:**
```typescript
{
  taskId: "task_a1b2c3d4"
}
```

#### `list_tasks`

View all parallel tasks and their status.

**Input:**
```typescript
{
  status?: "all" | "running" | "completed" | "error"
}
```

#### `cancel_task`

Stop a running task and free the concurrency slot.

**Input:**
```typescript
{
  taskId: "task_a1b2c3d4"
}
```

### Background Task Tools

#### `run_background`

Execute a shell command in the background.

**Input:**
```typescript
{
  command: "npm run build",
  cwd?: "/path/to/dir",
  timeout?: 300000,
  label?: "Build project"
}
```

#### `check_background`

Check status and output of a background task.

**Input:**
```typescript
{
  taskId: "job_a1b2c3d4",
  tailLines?: 50
}
```

#### `list_background`

List all background tasks.

#### `kill_background`

Terminate a running background task.

---

## Example Workflow

```
1. spawn_agent({ agent: "builder", prompt: "Implement feature X" })
   spawn_agent({ agent: "inspector", prompt: "Review module Y" })
   â†’ task_001 and task_002 start in parallel sessions

2. run_background({ command: "npm run build" })
   â†’ job_001 starts in background

3. (Agent continues other analysis work - NO WAITING)

4. [System notification appears]
   "All Parallel Tasks Complete"
   âœ… task_001: Implement feature X
   âœ… task_002: Review module Y

5. get_task_result({ taskId: "task_001" })
   â†’ Full output from builder agent

6. check_background({ taskId: "job_001" })
   â†’ Build output and exit code
```

---

## Related Files

| File | Description |
|------|-------------|
| `src/core/async-agent.ts` | ParallelAgentManager with ConcurrencyController |
| `src/tools/async-agent.ts` | delegate_task, get_task_result, list_tasks, cancel_task |
| `src/core/background.ts` | BackgroundTaskManager for shell commands |
| `src/tools/background.ts` | run_background, check_background, list_background, kill_background |
| `src/agents/orchestrator.ts` | Commander prompt with parallel execution guidelines |

---

## Monitoring

All parallel task lifecycle events are logged to the console (no env variable needed):

```
[orchestrator] v0.2.4 loaded

[parallel] ğŸš€ SPAWNED task_a1b2 â†’ builder: Implement feature X
[parallel] ğŸš€ SPAWNED task_c3d4 â†’ inspector: Review module Y
[parallel] âœ… COMPLETED task_c3d4 â†’ inspector: Review module Y (45s)
[parallel] âœ… COMPLETED task_a1b2 â†’ builder: Implement feature X (2m 30s)
[parallel] ğŸ—‘ï¸ CLEANED task_c3d4 (session deleted)
[parallel] ğŸ—‘ï¸ CLEANED task_a1b2 (session deleted)
```

| Event | Log Prefix |
|-------|------------|
| Spawn | ğŸš€ SPAWNED |
| Complete | âœ… COMPLETED (duration) |
| Cancel | ğŸ›‘ CANCELLED |
| Timeout | â±ï¸ TIMEOUT |
| Cleanup | ğŸ—‘ï¸ CLEANED (session deleted) |

For verbose debug logs:
```bash
DEBUG_PARALLEL_AGENT=true opencode
```

---

## Trigger Prompts

To trigger parallel execution, use prompts like:

```
"Build and test in parallel"
"Implement feature X while reviewing module Y"
"Run linting, tests, and build at the same time"
```

Commander will automatically use `delegate_task` with `background: true` for independent tasks.

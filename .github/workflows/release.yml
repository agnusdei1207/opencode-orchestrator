name: Build & Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary: orchestrator-linux-x64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            binary: orchestrator-linux-arm64
          - os: macos-latest
            target: x86_64-apple-darwin
            binary: orchestrator-macos-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            binary: orchestrator-macos-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary: orchestrator-windows-x64.exe

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - name: Rename binary (Unix)
        if: runner.os != 'Windows'
        run: |
          cp target/${{ matrix.target }}/release/orchestrator ${{ matrix.binary }}
          chmod +x ${{ matrix.binary }}

      - name: Rename binary (Windows)
        if: runner.os == 'Windows'
        run: |
          cp target/${{ matrix.target }}/release/orchestrator.exe ${{ matrix.binary }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary }}
          path: ${{ matrix.binary }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: binaries

      - name: Display structure of downloaded files
        run: ls -R binaries/

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: binaries/**/*
          body: |
            # ğŸŒŒ OpenCode Orchestrator ${{ github.ref_name }}
            # Next-Gen Autonomous Mastery: Powered by HPFAâ„¢ & MSVPâ„¢

            ---

            ### **The End of Sequential Limits. The Era of Fractal Mastery.**

            OpenCode Orchestrator is not just an agent; itâ€™s a **Titan-Class Execution Engine**. Powered by the revolutionary **HPFA (Hyper-Parallel Fractal Architecture)**, it is designed to conquer "impossible" missions with 0.1ms precision and infinite scalability.

            By fusing **Fractal Swarm Intelligence (HPFAâ„¢)** with **Continuous Multi-Stage Verification Pipeline (MSVPâ„¢)**, it delivers a level of scale, velocity, and architectural absolute previously considered impossible.

            ---

            ## ğŸ’ The Four Pillars of Excellence

            *   **âš¡ Velocity**: Parallelize up to **50 concurrent sessions** through **Cognitive Elasticity**.
            *   **ğŸ§¬ Scale**: **Fractal Delegation** allows workers to recursively spawn their own sub-agents.
            *   **ğŸ›¡ï¸ Safety**: **MSVPâ„¢** reviews every line of code in parallel "Shadow Sessions" before it ever touches your build.
            *   **â™¾ï¸ Trust**: **Iron-Clad Reliability** via Write-Ahead Logging (WAL). Represents a "permanent memory" for autonomous missions.

            ---

            ## ğŸ›ï¸ Hyper-Parallel Architecture: HPFA & MSVP

The orchestrator eliminates the linear reasoning bottleneck of conventional AI agents by shifting from sequential execution to a **Distributed Runtime Unit** paradigm.

### ğŸ§¬ **HPFAâ„¢ (Hyper-Parallel Fractal Architecture)**
*   **Fractal Delegation**: Workers are instantiated as autonomous controllers with localized `TaskLauncher` contexts. This enables recursive spawning of sub-agents up to 8 levels deep.
*   **Cognitive Concurrency Control**: Manages up to 50 concurrent sessions with dynamic slot scaling based on success/failure trajectories.

### ğŸ›¡ï¸ **MSVPâ„¢ (Multi-Stage Verification Pipeline)**
*   **Shadow Review Pipeline**: Parallel reviewer sessions are instantly snapshotted upon file-write, providing zero-latency audit without blocking implementation.
*   **Global Barrier-Sync Protocol**: Enforces a synchronized verification gate requiring consistency across all units before final E2E sealing.

            ```
                          /task "Build Complex System"
                                       â”‚
                       â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                       â•‘     ğŸ¯ COMMANDER â€” Orchestrator       â•‘
                       â•‘        (Main Session - Single)        â•‘
                       â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                           â”‚
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–¼â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                â•‘          ğŸš€ PHASE 0: DISCOVERY SWARM (Parallel)      â•‘
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                â”‚               â”‚               â”‚               â”‚
                â–¼ Scout         â–¼ Scout         â–¼ Scout         â–¼ Scout
             [Structure]      [Stack]         [Docs]          [Infra]
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ Consolidate & Sync
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚      ğŸ“‹ PLANNER â€” Create Plan         â”‚
                       â”‚    â†’ Outputs: Architectural Grid      â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                â•‘            ğŸ”¥ HPFA PARALLEL GRID (MSVP)           â•‘
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                â”‚               â”‚               â”‚               â”‚
                â–¼               â–¼               â–¼               â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ğŸ”¨ WORKER â”‚    â”‚ğŸ”¨ WORKER â”‚    â”‚ğŸ”¨ WORKER â”‚    â”‚ğŸ”¨ WORKER â”‚  <-- Fractal Spawning
            â”‚ Module A â”‚    â”‚ Module B â”‚    â”‚ Module C â”‚    â”‚ Module D â”‚
            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                 â”‚ âš¡ Instant    â”‚ âš¡ Instant    â”‚ âš¡ Instant    â”‚ âš¡ Instant
                 â–¼ Review       â–¼ Review       â–¼ Review       â–¼ Review
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚âœ… REVIEWRâ”‚    â”‚âœ… REVIEWRâ”‚    â”‚âœ… REVIEWRâ”‚    â”‚âœ… REVIEWRâ”‚  <-- Stage 1: Unit
            â”‚ (Unit-A) â”‚    â”‚ (Unit-B) â”‚    â”‚ (Unit-C) â”‚    â”‚ (Unit-D) â”‚      Verification
            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                 â”‚               â”‚               â”‚               â”‚
                â•â–¼â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–¼â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–¼â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–¼â•â•â•â•
                â•‘                â³ SYNC BARRIER                     â•‘
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                           â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚      âœ… MASTER REVIEWER â€” Final Pass  â”‚
                       â”‚         (Cross-module Integration)    â”‚
                       â”‚    â†’ Stage 2: E2E & System Integrity  â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚   Seal Conditions â”‚
                                 â”‚   Verified?       â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     No â†™     â†˜ Yes
                                 â™»ï¸ LOOP    ğŸ–ï¸ MISSION
                                (Adaptive)   SEALED
            ```

            ---

            ## âœ¨ Release Features

            | Feature | Description |
            |:---------|:-------------|
            | ğŸš€ **MSVPâ„¢ Pipeline** | Parallelized unit reviews for zero-latency integrity |
            | ğŸ§¬ **Fractal Spawning** | Recursive sub-mission generation for massive complexity |
            | âš¡ **50 Parallel Tasks** | Titan-class execution density |
            | ğŸ”„ **Non-Stop Recovery** | WAL-based cognitive persistence |
            | ğŸ›¡ï¸ **Self-Scaling** | Dynamic concurrency management |
            | ğŸ©¹ **Memory Integrity** | 100% reclamation for infinite sessions |

            ---

            ## ğŸ“¦ Installation

            ```bash
            npm install -g opencode-orchestrator
            ```

            ---
          generate_release_notes: true
          fail_on_unmatched_files: false

      - name: Publish to GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://npm.pkg.github.com"
          scope: "@agnusdei1207"

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          registry-url: "https://npm.pkg.github.com"
          scope: "@agnusdei1207"

      - name: Install dependencies
        run: npm install --force

      - name: Prepare binaries for NPM
        run: |
          mkdir -p bin
          cp binaries/orchestrator-linux-x64/orchestrator-linux-x64 bin/
          cp binaries/orchestrator-linux-arm64/orchestrator-linux-arm64 bin/
          cp binaries/orchestrator-macos-x64/orchestrator-macos-x64 bin/
          cp binaries/orchestrator-macos-arm64/orchestrator-macos-arm64 bin/
          cp binaries/orchestrator-windows-x64.exe/orchestrator-windows-x64.exe bin/
          chmod +x bin/*

      - name: Publish to GitHub Registry
        run: |
          node -e "let pkg=require('./package.json'); pkg.name='@agnusdei1207/opencode-orchestrator'; pkg.publishConfig={registry:'https://npm.pkg.github.com'}; require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));"
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
